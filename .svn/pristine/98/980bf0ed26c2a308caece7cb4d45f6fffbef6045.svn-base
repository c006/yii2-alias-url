<?php
    /**
     * Created by PhpStorm.
     * User: user
     * Date: 5/25/14
     * Time: 10:55 PM
     */
    namespace c006\url\assets;

    use Yii;

    class AppAliasUrl
    {

        private static $key = 'alias-url';
        private static $key_base = 'alias-url-base';
        private static $params = [ ];
        private static $route_base = '';
        private static $first_complete = 0;


        static public function init()
        {

            Yii::trace('AppAliasUrl > init', 'JC');
            self::$first_complete = 0;
            self::$route_base     = self::getBaseRoute($_SERVER['REQUEST_URI']);
            Yii::trace('AppAliasUrl > BASE > ' . self::$route_base, 'JC');
        }


        static public function run($route, $anchor, $pathInfo = '')
        {

            $return = '';
            /** @var  $urlManager \yii\web\UrlManager */
            $route = (!empty($route)) ? urldecode($route) : '';
            Yii::trace('AppAliasUrl > ' . $route, 'JC');
            if ( !self::$first_complete ) {
                if ( !empty($route) || !empty($pathInfo) ) {
                    $return = self::first($route, $anchor, $pathInfo);
                }
            }
            else {
                $return = self::more($route, $anchor, $pathInfo);
            }
            self::$first_complete = 1;

            return $return;
        }


        private static function first($route, $anchor, $pathInfo = '')
        {

            $return = '';
            $uri    = '';
            if ( isset($_GET['r']) ) {
                $_GET['r'] = $uri;
                $return    = '/index.php?r=';
            }
            if ( !empty($route) ) {
                $uri = $route;
            }
            if ( !empty($pathInfo) ) {
                $uri = $pathInfo;
            }
            if ( $uri ) {
                $sql = "SELECT * FROM `alias_url` WHERE UPPER(`public`) LIKE ('" . strtoupper($uri) . "');";
                $row = Yii::$app->db->createCommand($sql)->queryOne();
                if ( $row !== FALSE ) {
                    $route = $return . $row['private'];
                }
            }
            Yii::trace('AppAliasUrl > first > ' . $route . $anchor, 'JC');

            return $route . $anchor;
        }


        static private function more($route, $anchor, $pathInfo = '')
        {

            $ok  = FALSE;
            $sql = "";
            Yii::trace('AppAliasUrl > more ### ' . $route . ' : ' . $anchor, 'JC');
            if ( strpos($route, '?r=') !== FALSE ) {
                $uri = self::getParams($route);
            }
            if ( empty($uri) && isset($_GET['r']) ) {
                $uri = $_GET['r'];
            }
            if ( !empty($uri) ) {
                $sql = "SELECT * FROM `alias_url` WHERE UPPER(`private`) LIKE ('" . strtoupper($uri) . "')";
                $row = Yii::$app->db->createCommand($sql)->queryOne();
                if ( $row !== FALSE ) {
                    $route = $row['public'];
                    $ok    = TRUE;
                }
            }
            else
                Yii::trace('AppAliasUrl > NO :: ' . $route, 'JC');
            if ( !empty($pathInfo) ) {
                $sql = "SELECT * FROM `alias_url` WHERE UPPER(`public`) LIKE ('" . strtoupper($pathInfo) . "')";
                $row = Yii::$app->db->createCommand($sql)->queryOne();
                if ( $row !== FALSE ) {
                    $route = $row['public'];
                    $ok    = TRUE;
                }
            }
//            if ( $ok ) {
//                Yii::trace('AppAliasUrl > BASE > ' . self::$route_base . ' == ' . self::getBaseRoute($route), 'JC');
//                if ( self::getBaseRoute($route) == self::$route_base ) {
//                    $route = str_replace(self::$route_base, '', $route);
//                    $route = preg_replace('/^\/+/', '', $route);
//                    Yii::trace('AppAliasUrl > ROUTE >>> ' . $route, 'JC');
//                }
//            }
            if ( is_array(self::$params) ) {
                $anchor = "";
                foreach (self::$params as $key => $value) {
                    if ( $key != "r" ) {
                        if ( empty($anchor) ) {
                            $anchor .= "{$key}={$value}";
                        }
                        else {
                            $anchor .= "&{$key}={$value}";
                        }
                    }
                }
                if ( !empty($anchor) ) {
                    $anchor = "?{$anchor}";
                }
            }
            Yii::trace('AppAliasUrl > more > ' . $route . $anchor, 'JC');

            return preg_replace('/\/+/', '/', $route . $anchor);
        }


        private static function getParams($route)
        {

            Yii::trace('AppAliasUrl > request ', 'JC');
            list($base, $query_string) = explode('?', $route);
            foreach (explode('&', $query_string) as $param) {
                $param                   = explode('=', $param);
                self::$params[$param[0]] = $param[1];
            }

            return (isset(self::$params['r'])) ? self::$params['r'] : '';
        }


        private static function getBaseRoute($route)
        {

            $route = preg_replace('/^\//', '', $route);
            if ( strpos($route, '/') !== FALSE ) {
                $route = explode('/', $route);

                return $route[0];
            }

            return $route;
        }
    }


